<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Formulario de Feedback - Entrenamiento de Agentes</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f6f8fb; --card:#ffffff; --accent:#1f6feb; --muted:#6b7280; --glass: rgba(31,111,235,0.06);
      --paper-bg: #ffffff;
      --text:#0f1724;
    }
    *{box-sizing:border-box}
    body{font-family: 'Lato', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; margin:0; background:linear-gradient(180deg,var(--bg),#eef3fb); color:var(--text);}
    .container{max-width:980px;margin:32px auto;padding:24px}
    header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
    .logo{width:64px;height:64px;border-radius:10px;background:var(--glass);display:flex;align-items:center;justify-content:center;font-weight:900;color:var(--accent)}
    h1{font-size:20px;margin:0}
    p.lead{margin:4px 0 0;color:var(--muted);font-size:13px}

    .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 6px 20px rgba(17,24,39,0.06);margin-top:16px}
    .grid2{display:grid;grid-template-columns:1fr 320px;gap:18px}
    label{display:block;font-weight:700;margin-bottom:8px;font-size:13px}
    input[type="text"], textarea, select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef9;background:#fbfdff;font-size:14px}
    textarea{min-height:100px;resize:vertical}
    .field{margin-bottom:12px}
    .section-title{display:flex;align-items:center;gap:10px;margin-bottom:12px}
    .section-title h2{font-size:16px;margin:0}
    .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

    button{background:var(--accent);color:white;padding:10px 14px;border-radius:10px;border:0;font-weight:700;cursor:pointer}
    button.secondary{background:transparent;color:var(--accent);border:2px solid var(--accent)}
    button.ghost{background:#fff;border:1px solid #e6eef9;color:var(--muted)}

    /* report preview */
    #report{background:var(--paper-bg);padding:26px;border-radius:6px;border:1px solid #eef3fb;margin-top:18px}
    .report-header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #eef3fb;padding-bottom:12px;margin-bottom:18px}
    .report-title{font-size:18px;font-weight:800}
    .meta{color:var(--muted);font-size:13px}
    .report-section{margin-bottom:14px}
    .report-section h3{font-size:14px;margin-bottom:8px}
    .agent-table{width:100%;border-collapse:collapse}
    .agent-table td{padding:8px;border-bottom:1px solid #f1f5f9}

    footer.notes{font-size:12px;color:var(--muted);margin-top:14px}

    @media (max-width:900px){.grid2{grid-template-columns:1fr;}.actions{justify-content:stretch}}

    /* print / pdf helpers */
    @media print{
      body{background:white}
      .container{box-shadow:none;margin:0;padding:0}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">F</div>
      <div>
        <h1>Formulario de Feedback — Recuperación / Nesting</h1>
        <p class="lead">Rellena los campos y genera un PDF profesional con el resumen.</p>
      </div>
    </header>

    <div class="card">
      <form id="feedbackForm">
        <div class="grid2">
          <div>
            <div class="section-title"><h2>1. Feedback general</h2></div>
            <div class="field">
              <label for="temas">Temas que se dieron</label>
              <textarea id="temas" name="temas" placeholder="Lista o resumen de los temas tratados (p. ej. 'Gestión de llamadas, uso de CRM, manejo de objeciones')"></textarea>
            </div>
            <div class="field">
              <label for="dudas">Dudas y temas más recurrentes</label>
              <textarea id="dudas" name="dudas" placeholder="Dudas frecuentes detectadas durante la sesión"></textarea>
            </div>
            <div class="field">
              <label for="preocupaciones">Preocupaciones del primer mes (operación)</label>
              <textarea id="preocupaciones" name="preocupaciones" placeholder="Riesgos operativos, cuellos de botella, KPIs en riesgo"></textarea>
            </div>
            <div class="field">
              <label for="puntos">Puntos a considerar para el próximo nesting</label>
              <textarea id="puntos" name="puntos" placeholder="Acciones concretas, prioridades y responsables"></textarea>
            </div>
          </div>

          <aside>
            <div class="field">
              <label for="trainer">Entrenador / Evaluador</label>
              <input type="text" id="trainer" name="trainer" placeholder="Nombre del entrenador">
            </div>
            <div class="field">
              <label for="team">Equipo / Proyecto</label>
              <input type="text" id="team" name="team" placeholder="Nombre del equipo o proyecto">
            </div>
            <div class="field">
              <label for="date">Fecha</label>
              <input type="text" id="date" name="date" value="" placeholder="DD/MM/AAAA">
            </div>
            <div class="field">
              <label for="location">Ubicación (opcional)</label>
              <input type="text" id="location" name="location" placeholder="Remoto / Sede X">
            </div>
          </aside>
        </div>

        <hr style="margin:18px 0;border:0;border-top:1px solid #f1f5f9">

        <div class="section-title"><h2>2. Feedback individual</h2></div>
        <p style="margin-top:0;margin-bottom:12px;color:var(--muted);font-size:13px">Los nombres de los agentes están definidos como encabezados fijos en el código. Debajo de cada uno, redacta el feedback individual correspondiente.</p>
        <div class="card" style="background:#fbfdff;border:1px solid #eef3fb">
          <h3 style="margin-top:0">Agente 1 — Juan Pérez</h3>
          <div class="field"><textarea id="a1" name="a1" placeholder="Feedback individual del agente 1"></textarea></div>

          <h3>Agente 2 — María Gómez</h3>
          <div class="field"><textarea id="a2" name="a2" placeholder="Feedback individual del agente 2"></textarea></div>

          <h3>Agente 3 — Carlos Rodríguez</h3>
          <div class="field"><textarea id="a3" name="a3" placeholder="Feedback individual del agente 3"></textarea></div>

          <h3>Agente 4 — Lucía Fernández</h3>
          <div class="field"><textarea id="a4" name="a4" placeholder="Feedback individual del agente 4"></textarea></div>

          <h3>Agente 5 — Andrés López</h3>
          <div class="field"><textarea id="a5" name="a5" placeholder="Feedback individual del agente 5"></textarea></div>

          <h3>Agente 6 — Sofía Martínez</h3>
          <div class="field"><textarea id="a6" name="a6" placeholder="Feedback individual del agente 6"></textarea></div>

          <h3>Agente 7 — Diego Torres</h3>
          <div class="field"><textarea id="a7" name="a7" placeholder="Feedback individual del agente 7"></textarea></div>
        </div>

        <div class="actions">
          <button type="button" id="previewBtn" class="ghost">Generar vista previa</button>
          <button type="button" id="downloadBtn" class="secondary">Descargar PDF</button>
        </div>
      </form>

      <div id="report" aria-live="polite" hidden>
        <!-- Se rellenará con JS -->
      </div>

      <p class="notes" style="margin-top:10px;color:var(--muted);font-size:13px">Consejo: usa "Generar vista previa" para revisar el formato antes de exportar. El PDF se genera en tamaño A4.</p>
    </div>

    <footer style="margin-top:18px;font-size:13px;color:var(--muted)">Generado por plantilla de feedback — plantilla optimizada para exportar en PDF. <span style="display:block;margin-top:8px">Curiosidad: la conversión en el navegador usa una combinación de <strong>html2canvas</strong> y <strong>jsPDF</strong> (html2pdf.js) para rasterizar y empaquetar el documento en PDF.</span></footer>
  </div>

  <!-- Dependencia para exportar a PDF (html2pdf bundle incluye jsPDF + html2canvas) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
  <script>
    // inicializar fecha por defecto (hoy)
    (function(){
      const dateInput = document.getElementById('date');
      const now = new Date();
      const dd = String(now.getDate()).padStart(2,'0');
      const mm = String(now.getMonth()+1).padStart(2,'0');
      const yyyy = now.getFullYear();
      dateInput.value = `${dd}/${mm}/${yyyy}`;
    })();

    function buildReportHtml(values){
      // Construye un HTML limpio y formateado para PDF
      const safe = (v)=> (v || '').toString().replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
      const agents = [
        {name:'Juan Pérez', text: values.a1},
        {name:'María Gómez', text: values.a2},
        {name:'Carlos Rodríguez', text: values.a3},
        {name:'Lucía Fernández', text: values.a4},
        {name:'Andrés López', text: values.a5},
        {name:'Sofía Martínez', text: values.a6},
        {name:'Diego Torres', text: values.a7}
      ];

      let agentsHtml = '<div class="report-section"><h3>Feedback individual</h3>';
      agents.forEach((a,i)=>{
        agentsHtml += `<div style="margin-bottom:10px"><strong>${i+1}. ${a.name}</strong><div style="margin-top:4px">${safe(a.text)}</div></div>`;
      });
      agentsHtml += '</div>';

      const footer = `<div class="report-section"><small class="meta">Reporte generado desde plantilla local — revise acciones y asigne responsables antes de distribuir.</small></div>`;

      const full = `
        <div style="font-family: 'Lato', Arial, sans-serif; color:#0f1724;">
          ${header}
          ${general}
          ${agentsHtml}
          ${footer}
        </div>`;

      return full;
    }

    function readForm(){
      const f = document.getElementById('feedbackForm');
      const data = {};
      new FormData(f).forEach((v,k)=>data[k]=v);
      return data;
    }

    function showPreview(){
      const values = readForm();
      const report = document.getElementById('report');
      report.innerHTML = buildReportHtml(values);
      report.hidden = false;
      // aplicar estilos minimalistas para preview
      report.querySelectorAll('h3').forEach(h=>h.style.margin='0 0 6px');
    }

    function downloadPdf(){
      const values = readForm();
      const reportHtml = buildReportHtml(values);

      // Crear un contenedor temporal (no visible) para el proceso de renderizado
      const wrapper = document.createElement('div');
      wrapper.style.background = '#fff';
      wrapper.style.padding = '18px';
      wrapper.innerHTML = reportHtml;

      // Opciones para html2pdf (A4, 10mm margin)
      const opt = {
        margin:       [10/25.4, 10/25.4, 10/25.4, 10/25.4], // inches (converted)
        filename:     `feedback_${(new Date()).toISOString().slice(0,10)}.pdf`,
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  { scale: 2, useCORS: true, allowTaint: false },
        jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };

      // Ejecutar la conversión
      document.body.appendChild(wrapper);
      html2pdf().set(opt).from(wrapper).save().then(()=>{
        document.body.removeChild(wrapper);
      }).catch(err=>{
        console.error(err);
        document.body.removeChild(wrapper);
        alert('Error al generar el PDF. Revisa la consola del navegador para más detalles.');
      });
    }

    document.getElementById('previewBtn').addEventListener('click', showPreview);
    document.getElementById('downloadBtn').addEventListener('click', downloadPdf);
  </script>
</body>
</html>
